<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bird Art Prompt Randomizer</title>

  <!-- If you're using an external CSS file, keep this. Otherwise you can delete it. -->
  <!-- <link rel="stylesheet" href="./birdprompt.css"> -->

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@600;700&family=Source+Sans+3:wght@400;500;600&display=swap');

    :root {
      --forest: #1F6F50;
      --ink: #1C1C1E;
      --sand: #F3EDE2;
      --card: rgba(255, 255, 255, 0.92);
      --border: rgba(31, 111, 80, 0.17);
      --shadow: 0 20px 45px rgba(12, 32, 20, 0.12);
      font-family: 'Source Sans 3', 'Segoe UI', system-ui, sans-serif;
      background-color: var(--sand);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      background: var(--sand);
      color: var(--ink);
      display: flex;
      justify-content: center;
      padding: 2rem 1rem 3rem;
    }

    .page-shell { width: 100%; max-width: 960px; }
    .page { display: flex; flex-direction: column; gap: 1rem; }

    .card {
      background: var(--card);
      border-radius: 22px;
      padding: 1.6rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .hero-card { display: flex; flex-direction: column; gap: 1rem; }
    .hero-copy h1 {
      margin: 0 0 0.2rem;
      font-family: 'Inter', sans-serif;
      font-size: clamp(2rem, 4vw, 2.8rem);
      line-height: 1.1;
      color: var(--ink);
    }
    .hero-copy p { margin: 0; color: #2f3430; font-size: 1rem; }
    .eyebrow {
      text-transform: uppercase;
      letter-spacing: 0.25em;
      font-size: 0.75rem;
      color: #4e6257;
      margin: 0;
    }

    .hero-actions { display: flex; flex-direction: column; gap: 0.75rem; }

    .primary-btn {
      border: none;
      background: var(--forest);
      color: white;
      font-weight: 600;
      border-radius: 999px;
      padding: 0.75rem 1.6rem;
      font-size: 1rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.6rem;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      box-shadow: 0 10px 20px rgba(31, 111, 80, 0.3);
    }
    .primary-btn:disabled { opacity: 0.65; cursor: wait; box-shadow: none; }
    .primary-btn:not(:disabled):active { transform: translateY(1px); box-shadow: 0 6px 10px rgba(31, 111, 80, 0.35); }
    .primary-btn .spinner {
      width: 18px; height: 18px;
      border: 2px solid rgba(255, 255, 255, 0.5);
      border-top-color: #f3ede2;
      border-radius: 50%;
      animation: spin 0.9s linear infinite;
      opacity: 0;
      transition: opacity 0.18s ease;
    }
    .primary-btn.loading .spinner { opacity: 1; }
    .primary-btn.loading { pointer-events: none; }

    .status {
      margin: 0;
      font-size: 0.9rem;
      color: #4e6257;
      min-height: 1.2rem;
    }
    .status[data-state='error'] { color: #b00020; }
    .status[data-state='success'] { color: var(--forest); }

    .filters-card {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
    }
    .filter-group label {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: #4e6257;
      margin-bottom: 0.35rem;
    }
    .filter-group select {
      width: 100%;
      padding: 0.65rem 0.75rem;
      border-radius: 12px;
      border: 1px solid rgba(0, 0, 0, 0.12);
      font-size: 1rem;
      background: #fff;
      outline: none;
      font-family: 'Source Sans 3', sans-serif;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.08);
      transition: border 0.2s ease;
    }
    .filter-group select:focus { border-color: var(--forest); }

    .prompt-card { display: flex; flex-direction: column; gap: 1.25rem; }
    .prompt-output { display: flex; flex-direction: column; gap: 0.75rem; }
    .prompt-output .label {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: #4e6257;
    }
    .prompt-text {
      border-radius: 18px;
      border: 1px solid rgba(31, 111, 80, 0.25);
      background: #fff;
      padding: 1rem 1.25rem;
      min-height: 120px;
      font-size: 1.05rem;
      line-height: 1.5;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.08);
      position: relative;
      overflow: hidden;
    }

    .ghost-btn {
      align-self: flex-end;
      background: transparent;
      border: 1px solid rgba(31, 111, 80, 0.5);
      border-radius: 999px;
      padding: 0.5rem 1.2rem;
      color: var(--forest);
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.18s ease;
    }
    .ghost-btn:active { transform: translateY(1px); }

    /* Details + lock switches */
    .bird-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.9rem;
    }
    .detail-item {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 0.8rem;
      border: 1px solid rgba(28, 28, 30, 0.06);
      background: rgba(255,255,255,0.7);
      border-radius: 14px;
      padding: 0.85rem 0.9rem;
    }
    .detail-item .label {
      margin: 0 0 0.2rem;
      font-size: 0.75rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: #4e6257;
    }
    .value {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
      color: var(--ink);
      word-break: break-word;
    }
    .value em { font-style: italic; color: #3c423d; font-weight: 500; }

    .lock-toggle {
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      user-select: none;
      cursor: pointer;
    }
    .lock-toggle input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }
    .lock-switch {
      width: 44px;
      height: 24px;
      border-radius: 999px;
      background: rgba(28, 28, 30, 0.18);
      border: 1px solid rgba(28, 28, 30, 0.12);
      position: relative;
      transition: background 0.18s ease, border-color 0.18s ease;
    }
    .lock-switch::after {
      content: '';
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: #fff;
      position: absolute;
      top: 50%;
      left: 3px;
      transform: translateY(-50%);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.12);
      transition: transform 0.18s ease;
    }
    .lock-toggle input:checked + .lock-switch {
      background: rgba(31, 111, 80, 0.28);
      border-color: rgba(31, 111, 80, 0.5);
    }
    .lock-toggle input:checked + .lock-switch::after {
      transform: translate(20px, -50%);
    }
    .lock-icon {
      font-size: 1rem;
      line-height: 1;
      color: #4e6257;
      width: 1.2rem;
      text-align: center;
    }
    .lock-toggle input:checked ~ .lock-icon { color: var(--forest); }
    .lock-icon .locked { display: none; }
    .lock-toggle input:checked ~ .lock-icon .unlocked { display: none; }
    .lock-toggle input:checked ~ .lock-icon .locked { display: inline; }

    .reference-panel figure {
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }
    .reference-panel img {
      width: 100%;
      border-radius: 18px;
      object-fit: cover;
      min-height: 180px;
      max-height: 360px;
      display: block;
      background: rgba(255,255,255,0.8);
      border: 1px solid rgba(31, 111, 80, 0.18);
    }
    .reference-panel a {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      color: var(--forest);
      font-weight: 600;
      text-decoration: none;
      font-size: 0.95rem;
    }
    .reference-panel a:hover { text-decoration: underline; }

    .favorites-history { display: grid; gap: 1rem; }
    .favorites-block, .history-block {
      background: #fff;
      border-radius: 18px;
      padding: 1.25rem;
      border: 1px solid rgba(28, 28, 30, 0.08);
    }
    .section-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }
    .section-header h2 {
      margin: 0;
      font-family: 'Inter', sans-serif;
      font-size: 1.2rem;
    }
    .secondary-btn {
      border-radius: 12px;
      border: 1px solid rgba(31, 111, 80, 0.6);
      background: #fff;
      color: var(--forest);
      padding: 0.5rem 1.25rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.18s ease;
    }
    .secondary-btn:active { transform: translateY(1px); }

    .list-grid { display: flex; flex-direction: column; gap: 0.9rem; margin-top: 0.8rem; }
    .helper { margin: 0; font-size: 0.85rem; color: #5c655e; }

    .favorite-card, .history-card {
      border: 1px solid rgba(31, 111, 80, 0.2);
      border-radius: 14px;
      padding: 0.9rem 1rem;
      background: #f9fafc;
      box-shadow: 0 8px 12px rgba(0, 0, 0, 0.05);
    }
    .prompt-snippet { margin: 0 0 0.5rem; font-size: 0.95rem; line-height: 1.3; }
    .history-actions, .favorite-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .history-actions button, .favorite-meta button {
      border: none;
      background: rgba(31, 111, 80, 0.12);
      color: var(--forest);
      padding: 0.35rem 0.9rem;
      border-radius: 999px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .history-actions button:hover, .favorite-meta button:hover { background: rgba(31, 111, 80, 0.2); }
    .timestamp { font-size: 0.8rem; color: #5c655e; }

    .footer-card {
      margin-top: 1rem;
      text-align: center;
      font-size: 0.85rem;
      color: #4e6257;
      border-radius: 18px;
      border: 1px solid rgba(28, 28, 30, 0.08);
    }

    .prompt-card.fresh { animation: softGlow 0.7s ease; }

    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes softGlow {
      0% { transform: translateY(6px); opacity: 0.85; }
      100% { transform: translateY(0); opacity: 1; }
    }

    @media (min-width: 768px) {
      .hero-actions { flex-direction: row; align-items: center; justify-content: space-between; }
      .hero-card { flex-direction: row; align-items: flex-start; justify-content: space-between; }
      .hero-copy { max-width: 60%; }
      .favorites-history { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .filters-card { grid-template-columns: repeat(2, minmax(220px, 1fr)); }
    }
  </style>
</head>

<body>
  <div class="page-shell">
    <main class="page" aria-live="polite">
      <header class="hero-card card">
        <div class="hero-copy">
          <p class="eyebrow">Field-guided inspiration</p>
          <h1>Bird Art Prompt Randomizer</h1>
          <p>Blend real species reference imagery with curated actions, styles, and views to spark fresh bird art studies.</p>
        </div>
        <div class="hero-actions">
          <button id="generateBtn" class="primary-btn" type="button" aria-live="polite">
            <span class="btn-label">Generate Prompt</span>
            <span class="spinner" aria-hidden="true"></span>
          </button>
          <p id="statusMessage" class="status" aria-live="polite">Tap generate to invite a feathered muse.</p>
        </div>
      </header>

      <section class="card filters-card">
        <div class="filter-group">
          <label for="lifeSelect">Life Status <span class="icon">ü™∂</span></label>
          <select id="lifeSelect">
            <option value="Any">Any</option>
            <option value="Living">Living</option>
            <option value="Extinct">Extinct</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="regionSelect">Region <span class="icon">üìç</span></label>
          <select id="regionSelect">
            <option value="Any">Any</option>
            <option value="North America">North America</option>
            <option value="South America">South America</option>
            <option value="Europe">Europe</option>
            <option value="Africa">Africa</option>
            <option value="Asia">Asia</option>
            <option value="Oceania">Oceania</option>
            <option value="Island">Island</option>
          </select>
        </div>
      </section>

      <section class="card prompt-card">
        <div class="prompt-output">
          <p class="label">Prompt</p>
          <div class="prompt-text" id="promptText">Tap ‚ÄúGenerate Prompt‚Äù to start.</div>
          <button id="copyPrompt" class="ghost-btn" type="button">Copy Prompt</button>
        </div>

        <div class="bird-details">
          <div class="detail-item">
            <div>
              <p class="label">Bird</p>
              <p class="value" id="birdCommon">‚Äî</p>
              <p class="value"><em id="scientificName">‚Äî</em></p>
            </div>
            <label class="lock-toggle" title="Lock bird">
              <input type="checkbox" id="lockBird" />
              <span class="lock-switch" aria-hidden="true"></span>
              <span class="lock-icon" aria-hidden="true"><span class="unlocked">üîì</span><span class="locked">üîí</span></span>
            </label>
          </div>

          <div class="detail-item">
            <div>
              <p class="label">Action</p>
              <p class="value" id="detailAction">‚Äî</p>
            </div>
            <label class="lock-toggle" title="Lock action">
              <input type="checkbox" id="lockAction" />
              <span class="lock-switch" aria-hidden="true"></span>
              <span class="lock-icon" aria-hidden="true"><span class="unlocked">üîì</span><span class="locked">üîí</span></span>
            </label>
          </div>

          <div class="detail-item">
            <div>
              <p class="label">Style</p>
              <p class="value" id="detailStyle">‚Äî</p>
            </div>
            <label class="lock-toggle" title="Lock style">
              <input type="checkbox" id="lockStyle" />
              <span class="lock-switch" aria-hidden="true"></span>
              <span class="lock-icon" aria-hidden="true"><span class="unlocked">üîì</span><span class="locked">üîí</span></span>
            </label>
          </div>

          <div class="detail-item">
            <div>
              <p class="label">View</p>
              <p class="value" id="detailView">‚Äî</p>
            </div>
            <label class="lock-toggle" title="Lock view">
              <input type="checkbox" id="lockView" />
              <span class="lock-switch" aria-hidden="true"></span>
              <span class="lock-icon" aria-hidden="true"><span class="unlocked">üîì</span><span class="locked">üîí</span></span>
            </label>
          </div>

          <div class="detail-item">
            <div>
              <p class="label">Life Status</p>
              <p class="value" id="detailLifeStatus">‚Äî</p>
            </div>
            <label class="lock-toggle" title="Lock life status">
              <input type="checkbox" id="lockLifeStatus" />
              <span class="lock-switch" aria-hidden="true"></span>
              <span class="lock-icon" aria-hidden="true"><span class="unlocked">üîì</span><span class="locked">üîí</span></span>
            </label>
          </div>

          <div class="detail-item">
            <div>
              <p class="label">Region</p>
              <p class="value" id="detailRegion">‚Äî</p>
            </div>
            <label class="lock-toggle" title="Lock region">
              <input type="checkbox" id="lockRegion" />
              <span class="lock-switch" aria-hidden="true"></span>
              <span class="lock-icon" aria-hidden="true"><span class="unlocked">üîì</span><span class="locked">üîí</span></span>
            </label>
          </div>
        </div>

        <div class="reference-panel">
          <figure>
            <img id="referenceImage"
                 src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='800' height='500'%3E%3C/svg%3E"
                 alt="Bird reference will appear here" loading="lazy" />
            <figcaption>
              <a id="referenceLink" href="#" target="_blank" rel="noreferrer">Source image on Wikipedia ‚Üó</a>
            </figcaption>
          </figure>
        </div>
      </section>

      <section class="card favorites-history">
        <div class="favorites-block">
          <div class="section-header">
            <h2>Favorites</h2>
            <button id="saveFavorite" class="secondary-btn" type="button">Save Favorite</button>
          </div>
          <div id="favoritesList" class="list-grid">
            <p class="helper">Save prompts you love to revisit.</p>
          </div>
        </div>

        <div class="history-block">
          <div class="section-header">
            <h2>History</h2>
            <p class="helper">Last 10 prompts ‚Ä¢ tap to reload.</p>
          </div>
          <div id="historyList" class="list-grid">
            <p class="helper">History logs appear after you generate.</p>
          </div>
        </div>
      </section>
    </main>

    <footer class="footer-card card">
      <p>Images + data from Wikipedia/Wikidata. No tracking ‚Äî favorites & history stay local.</p>
    </footer>
  </div>

  <script>
    (() => {
            // --- DEBUG: show errors on the page so you don't have to hunt the console ---
      window.addEventListener('error', (e) => {
        const msg = e?.message || 'Unknown script error';
        const el = document.getElementById('statusMessage');
        if (el) {
          el.textContent = `JS error: ${msg}`;
          el.dataset.state = 'error';
        }
      });

      window.addEventListener('unhandledrejection', (e) => {
        const msg = (e?.reason && (e.reason.message || String(e.reason))) || 'Unknown promise rejection';
        const el = document.getElementById('statusMessage');
        if (el) {
          el.textContent = `Fetch error: ${msg}`;
          el.dataset.state = 'error';
        }
      });
      // --- end debug ---
      const actionsList = [
        'perched on a branch','soaring mid-flight','hunting over water','preening feathers','feeding chicks',
        'calling loudly','wading in shallows','hovering above flowers','diving for fish','dust bathing',
        'opening wings to sun','gliding over cliffs','nesting on a ledge','pecking at bark','scratching the ground',
        'balancing on a reed','resting on driftwood','chasing insects','carrying nesting material','sipping nectar',
        'strutting on display','swimming calmly','leaping from a perch','shaking off rain'
      ];

      const stylesList = [
        'watercolor wash','ink line art','vintage field-guide plate','low-poly geometric','charcoal sketch',
        'pastel painting','cyberpunk neon','ukiyo-e inspired','minimal flat','photorealistic study',
        'abstract shapes','stained-glass mosaic','impressionist brushwork','paper cut-out','bold poster art',
        'pixel art','colored pencil','mid-century modern'
      ];

      const viewsList = [
        'side profile','three-quarter view','frontal portrait','top-down','wings spread','close-up headshot',
        'full-body','in-environment scene','silhouette at sunset','macro detail of plumage'
      ];

      // Fallback list in case Wikidata is down / rate-limiting (rare, but nice)
      const fallbackBirds = [
        { commonName:'Northern Cardinal', scientificName:'Cardinalis cardinalis', wiki:'https://en.wikipedia.org/wiki/Northern_cardinal', lifeStatus:'Living', region:'North America' },
        { commonName:'Passenger Pigeon', scientificName:'Ectopistes migratorius', wiki:'https://en.wikipedia.org/wiki/Passenger_pigeon', lifeStatus:'Extinct', region:'North America' },
        { commonName:'KƒÅkƒÅp≈ç', scientificName:'Strigops habroptilus', wiki:'https://en.wikipedia.org/wiki/Kakapo', lifeStatus:'Living', region:'Oceania' }
      ];

      const favoritesKey = 'birdPromptFavorites';
      const historyKey = 'birdPromptHistory';

      const state = {
        currentBird: null,
        currentAction: '',
        currentStyle: '',
        currentView: '',
        currentLifeStatus: '',
        currentRegion: '',
        currentPromptText: '',
        locks: {
          bird: false,
          action: false,
          style: false,
          view: false,
          lifeStatus: false,
          region: false
        },
        cache: [],
        favorites: [],
        history: [],
        isGenerating: false
      };

      let generateBtn, copyBtn, saveFavoriteBtn;
      let lifeSelect, regionSelect, statusMessage, promptText, promptCard;
      let birdCommonEl, scientificEl, detailLifeStatus, detailRegion;
      let detailActionEl, detailStyleEl, detailViewEl;
      let referenceImage, referenceLink;
      let favoritesList, historyList;

      let lockBirdToggle, lockActionToggle, lockStyleToggle, lockViewToggle, lockLifeToggle, lockRegionToggle;

      document.addEventListener('DOMContentLoaded', () => {
        generateBtn = document.getElementById('generateBtn');
        copyBtn = document.getElementById('copyPrompt');
        saveFavoriteBtn = document.getElementById('saveFavorite');

        lifeSelect = document.getElementById('lifeSelect');
        regionSelect = document.getElementById('regionSelect');

        statusMessage = document.getElementById('statusMessage');
        promptText = document.getElementById('promptText');
        promptCard = document.querySelector('.prompt-card');

        birdCommonEl = document.getElementById('birdCommon');
        scientificEl = document.getElementById('scientificName');
        detailLifeStatus = document.getElementById('detailLifeStatus');
        detailRegion = document.getElementById('detailRegion');

        detailActionEl = document.getElementById('detailAction');
        detailStyleEl = document.getElementById('detailStyle');
        detailViewEl = document.getElementById('detailView');

        referenceImage = document.getElementById('referenceImage');
        referenceLink = document.getElementById('referenceLink');

        favoritesList = document.getElementById('favoritesList');
        historyList = document.getElementById('historyList');

        lockBirdToggle = document.getElementById('lockBird');
        lockActionToggle = document.getElementById('lockAction');
        lockStyleToggle = document.getElementById('lockStyle');
        lockViewToggle = document.getElementById('lockView');
        lockLifeToggle = document.getElementById('lockLifeStatus');
        lockRegionToggle = document.getElementById('lockRegion');

        // init toggles
        lockBirdToggle.checked = state.locks.bird;
        lockActionToggle.checked = state.locks.action;
        lockStyleToggle.checked = state.locks.style;
        lockViewToggle.checked = state.locks.view;
        lockLifeToggle.checked = state.locks.lifeStatus;
        lockRegionToggle.checked = state.locks.region;

        // sync state from UI
        lockBirdToggle.addEventListener('change', () => state.locks.bird = lockBirdToggle.checked);
        lockActionToggle.addEventListener('change', () => state.locks.action = lockActionToggle.checked);
        lockStyleToggle.addEventListener('change', () => state.locks.style = lockStyleToggle.checked);
        lockViewToggle.addEventListener('change', () => state.locks.view = lockViewToggle.checked);
        lockLifeToggle.addEventListener('change', () => state.locks.lifeStatus = lockLifeToggle.checked);
        lockRegionToggle.addEventListener('change', () => state.locks.region = lockRegionToggle.checked);

        generateBtn.addEventListener('click', handleGenerate);
        copyBtn.addEventListener('click', copyPrompt);
        saveFavoriteBtn.addEventListener('click', saveFavorite);

        historyList.addEventListener('click', handleHistoryClick);
        favoritesList.addEventListener('click', handleFavoriteClick);

        setStatus('Tap generate to invite a feathered muse.');
        loadFavorites();
        loadHistory();
        updatePromptDisplay();

        // If you WANT it to auto-generate on load, uncomment:
        // handleGenerate();
      });

      function setStatus(message, type = 'info') {
        statusMessage.textContent = message;
        statusMessage.dataset.state = type;
      }

      function toggleGenerateState(isLoading) {
        generateBtn.disabled = isLoading;
        generateBtn.classList.toggle('loading', isLoading);
        generateBtn.setAttribute('aria-busy', isLoading ? 'true' : 'false');
      }

      function pickRandom(list, exclude) {
        if (!list.length) return '';
        if (list.length === 1) return list[0];
        let choice = list[Math.floor(Math.random() * list.length)];
        if (choice === exclude) {
          const alt = list.filter(x => x !== exclude);
          choice = alt[Math.floor(Math.random() * alt.length)];
        }
        return choice;
      }

      function formatPrompt(bird, style, view, action) {
        const lifeLower = (bird.lifeStatus || 'Living').toLowerCase();
        const regionText = bird.region && bird.region !== 'Any' ? bird.region : 'anywhere';
        return `Create a ${style} depiction of a ${bird.commonName} (${bird.scientificName}), ${view} view, ${action}. Region inspiration: ${regionText}. Life status: ${lifeLower}.`;
      }

      function updatePromptDisplay() {
        promptText.textContent = state.currentPromptText || 'Tap ‚ÄúGenerate Prompt‚Äù to start.';

        birdCommonEl.textContent = state.currentBird ? state.currentBird.commonName : '‚Äî';
        scientificEl.textContent = state.currentBird ? state.currentBird.scientificName : '‚Äî';
        detailLifeStatus.textContent = state.currentBird ? state.currentBird.lifeStatus : '‚Äî';
        detailRegion.textContent = state.currentBird ? state.currentBird.region : '‚Äî';

        detailActionEl.textContent = state.currentAction || '‚Äî';
        detailStyleEl.textContent = state.currentStyle || '‚Äî';
        detailViewEl.textContent = state.currentView || '‚Äî';

        if (state.currentBird) {
          referenceImage.src = state.currentBird.image || blankImg();
          referenceImage.alt = `${state.currentBird.commonName} reference`;
          referenceLink.href = state.currentBird.wiki || '#';
          referenceLink.textContent = 'Source image on Wikipedia ‚Üó';
        } else {
          referenceImage.src = blankImg();
          referenceLink.href = '#';
        }

        if (promptCard) {
          promptCard.classList.add('fresh');
          setTimeout(() => promptCard.classList.remove('fresh'), 800);
        }
      }

      function blankImg() {
        return "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='800' height='500'%3E%3C/svg%3E";
      }

      function bucketRegionFromText(text) {
        const t = (text || '').toLowerCase();
        if (!t) return null;
        if (t.includes('north america')) return 'North America';
        if (t.includes('south america')) return 'South America';
        if (t.includes('europe')) return 'Europe';
        if (t.includes('africa')) return 'Africa';
        if (t.includes('asia')) return 'Asia';
        if (t.includes('oceania') || t.includes('australia') || t.includes('new zealand')) return 'Oceania';
        if (t.includes('island') || t.includes('archipelago')) return 'Island';
        return null;
      }

      async function sparqlQuery(query) {
        const url = 'https://query.wikidata.org/sparql?format=json&query=' + encodeURIComponent(query);
        const res = await fetch(url, { headers: { 'accept': 'application/sparql-results+json' } });
        if (!res.ok) throw new Error('SPARQL failed: ' + res.status);
        return res.json();
      }

      async function fetchWikiSummary(title) {
        const apiUrl = `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
        const res = await fetch(apiUrl, { headers: { accept: 'application/json' } });
        if (!res.ok) return null;
        return res.json();
      }

      function isExtinctIucn(qid) {
        // extinct species / extinct in the wild
        return qid === 'http://www.wikidata.org/entity/Q237350' || qid === 'http://www.wikidata.org/entity/Q239509';
      }

      async function fetchRandomBirdFromWikidata(filters) {
        // filters: { lifeStatus: 'Living'|'Extinct'|null, region: 'North America'|...|null }

        const extinctClause = `
          ?item wdt:P141 ?iucn .
          FILTER(?iucn IN (wd:Q237350, wd:Q239509))
        `;
        const livingClause = `
          FILTER NOT EXISTS {
            ?item wdt:P141 ?i2 .
            FILTER(?i2 IN (wd:Q237350, wd:Q239509))
          }
        `;

        const lifeBlock =
          filters.lifeStatus === 'Extinct' ? extinctClause :
          filters.lifeStatus === 'Living' ? livingClause :
          '';

        const query = `
SELECT ?item ?itemLabel ?sci ?enwiki ?iucn WHERE {
  ?item wdt:P31 wd:Q16521 .
  ${lifeBlock}
  OPTIONAL { ?item wdt:P225 ?sci . }
  OPTIONAL { ?item wdt:P141 ?iucn . }
  OPTIONAL {
    ?enwiki schema:about ?item ;
           schema:isPartOf <https://en.wikipedia.org/> .
  }
  FILTER(BOUND(?enwiki))
  SERVICE wikibase:label { bd:serviceParam wikibase:language "en". }
}
ORDER BY RAND()
LIMIT 25
        `.trim();

        const json = await sparqlQuery(query);
        const rows = json?.results?.bindings || [];
        if (!rows.length) return null;

        const preferred = rows.find(r => r.sci?.value) || rows[0];
        const commonName = preferred.itemLabel?.value || 'Unknown bird';
        const scientificName = preferred.sci?.value || '‚Äî';
        const wikiUrl = preferred.enwiki?.value;

        const title = decodeURIComponent((wikiUrl.split('/wiki/')[1] || '').replace(/_/g, ' '));
        const summary = await fetchWikiSummary(title);

        const thumb = summary?.thumbnail?.source || summary?.originalimage?.source || null;
        const extract = summary?.extract || '';
        const regionGuess = bucketRegionFromText(extract);

        const iucnVal = preferred.iucn?.value || null;
        const extinctByIucn = iucnVal ? isExtinctIucn(iucnVal) : false;

        const lifeStatus =
          filters.lifeStatus ? filters.lifeStatus :
          (extinctByIucn ? 'Extinct' : 'Living');

        return {
          commonName,
          scientificName,
          lifeStatus,
          region: regionGuess || 'Any',
          image: thumb || blankImg(),
          wiki: wikiUrl
        };
      }

      async function attemptBirdSelection(filters) {
        const maxTries = filters.region ? 10 : 4;

        for (let i = 0; i < maxTries; i++) {
          const bird = await fetchRandomBirdFromWikidata(filters);
          if (!bird) continue;

          if (filters.region && bird.region !== filters.region) continue;

          return bird;
        }
        return null;
      }

      function cacheBird(bird) {
        state.cache = state.cache.filter(e => e.wiki !== bird.wiki);
        state.cache.unshift(bird);
        if (state.cache.length > 20) state.cache.pop();
      }

      async function handleGenerate() {
        if (state.isGenerating) return;

        state.isGenerating = true;
        setStatus('Finding a bird‚Ä¶');
        toggleGenerateState(true);

        try {
          const lifeFilter =
            state.locks.lifeStatus && state.currentLifeStatus
              ? state.currentLifeStatus
              : (lifeSelect.value !== 'Any' ? lifeSelect.value : null);

          const regionFilter =
            state.locks.region && state.currentRegion
              ? state.currentRegion
              : (regionSelect.value !== 'Any' ? regionSelect.value : null);

          const filters = { lifeStatus: lifeFilter, region: regionFilter };

          const selectedBird =
            state.locks.bird && state.currentBird
              ? state.currentBird
              : await attemptBirdSelection(filters);

          // If Wikidata fails, fallback to a small built-in list
          const finalBird = selectedBird || fallbackBirds[Math.floor(Math.random() * fallbackBirds.length)];

          // If fallback bird, fetch its wiki summary for image
          if (!finalBird.image && finalBird.wiki) {
            const title = decodeURIComponent((finalBird.wiki.split('/wiki/')[1] || '').replace(/_/g,' '));
            const summary = await fetchWikiSummary(title);
            finalBird.image = summary?.thumbnail?.source || summary?.originalimage?.source || blankImg();
          }

          state.currentBird = finalBird;
          state.currentLifeStatus = finalBird.lifeStatus || (lifeFilter || 'Living');
          state.currentRegion = finalBird.region || (regionFilter || 'Any');

          const actionChoice = (state.locks.action && state.currentAction) ? state.currentAction : pickRandom(actionsList, state.currentAction);
          const styleChoice  = (state.locks.style && state.currentStyle) ? state.currentStyle : pickRandom(stylesList, state.currentStyle);
          const viewChoice   = (state.locks.view && state.currentView) ? state.currentView : pickRandom(viewsList, state.currentView);

          state.currentAction = actionChoice;
          state.currentStyle = styleChoice;
          state.currentView = viewChoice;

          const prompt = formatPrompt(finalBird, state.currentStyle, state.currentView, state.currentAction);
          state.currentPromptText = prompt;

          updatePromptDisplay();
          cacheBird(finalBird);

          logHistory({
            prompt,
            bird: { ...finalBird },
            action: state.currentAction,
            style: state.currentStyle,
            view: state.currentView,
            lifeStatus: finalBird.lifeStatus,
            region: finalBird.region,
            timestamp: Date.now()
          });

          setStatus('Prompt ready ‚Äî let the wings inspire you.', 'success');
        } catch (e) {
          setStatus("Something went wrong fetching bird data ‚Äî try again.", 'error');
        } finally {
          toggleGenerateState(false);
          state.isGenerating = false;
        }
      }

      function saveFavorite() {
        if (!state.currentPromptText || !state.currentBird) return;

        const favorite = {
          prompt: state.currentPromptText,
          bird: { ...state.currentBird },
          action: state.currentAction,
          style: state.currentStyle,
          view: state.currentView,
          timestamp: Date.now()
        };

        state.favorites = state.favorites.filter(i => i.prompt !== favorite.prompt);
        state.favorites.unshift(favorite);
        if (state.favorites.length > 20) state.favorites.pop();

        persistFavorites();
        renderFavorites();
        setStatus('Saved to favorites. It stays on this device only.', 'success');
      }

      function removeFavorite(index) {
        if (index < 0 || index >= state.favorites.length) return;
        state.favorites.splice(index, 1);
        persistFavorites();
        renderFavorites();
        setStatus('Favorite removed.', 'info');
      }

      function handleFavoriteClick(event) {
        const button = event.target.closest('[data-remove-fav]');
        if (!button) return;
        removeFavorite(Number(button.dataset.removeFav));
      }

      function handleHistoryClick(event) {
        const button = event.target.closest('[data-history-index]');
        if (!button) return;
        const index = Number(button.dataset.historyIndex);
        const entry = state.history[index];
        if (!entry) return;
        applyHistoryEntry(entry);
      }

      function applyHistoryEntry(entry) {
        state.currentBird = entry.bird;
        state.currentAction = entry.action;
        state.currentStyle = entry.style;
        state.currentView = entry.view;
        state.currentLifeStatus = entry.lifeStatus;
        state.currentRegion = entry.region;
        state.currentPromptText = entry.prompt;

        updatePromptDisplay();
        cacheBird(entry.bird);

        logHistory({
          ...entry,
          timestamp: Date.now()
        });

        setStatus('Reloaded from history.', 'success');
      }

      function logHistory(entry) {
        state.history = state.history.filter(i => i.prompt !== entry.prompt);
        state.history.unshift(entry);
        if (state.history.length > 10) state.history.pop();
        persistHistory();
        renderHistory();
      }

      function renderFavorites() {
        favoritesList.innerHTML = '';
        if (!state.favorites.length) {
          favoritesList.innerHTML = '<p class="helper">No favorites yet.</p>';
          return;
        }

        state.favorites.forEach((fav, index) => {
          const article = document.createElement('article');
          article.className = 'favorite-card';
          article.innerHTML = `
            <p class="prompt-snippet">${escapeHtml(fav.prompt)}</p>
            <div class="favorite-meta">
              <span class="timestamp">${formatTimestamp(fav.timestamp)}</span>
              <button type="button" data-remove-fav="${index}" aria-label="Remove favorite">Remove</button>
            </div>
          `;
          favoritesList.appendChild(article);
        });
      }

      function renderHistory() {
        historyList.innerHTML = '';
        if (!state.history.length) {
          historyList.innerHTML = '<p class="helper">History logs appear after you generate.</p>';
          return;
        }

        state.history.forEach((entry, index) => {
          const article = document.createElement('article');
          article.className = 'history-card';
          article.innerHTML = `
            <p class="prompt-snippet">${escapeHtml(entry.prompt)}</p>
            <div class="history-actions">
              <button type="button" data-history-index="${index}">Reload</button>
              <span class="timestamp">${formatTimestamp(entry.timestamp)}</span>
            </div>
          `;
          historyList.appendChild(article);
        });
      }

      function loadFavorites() {
        state.favorites = readStorage(favoritesKey);
        renderFavorites();
      }

      function loadHistory() {
        state.history = readStorage(historyKey);
        renderHistory();
      }

      function persistFavorites() { safeSet(favoritesKey, state.favorites); }
      function persistHistory() { safeSet(historyKey, state.history); }

      function readStorage(key) {
        if (typeof localStorage === 'undefined') return [];
        try {
          const stored = localStorage.getItem(key);
          return stored ? JSON.parse(stored) : [];
        } catch {
          return [];
        }
      }

      function safeSet(key, value) {
        if (typeof localStorage === 'undefined') return;
        try {
          localStorage.setItem(key, JSON.stringify(value));
        } catch {
          // ignore
        }
      }

      function formatTimestamp(timestamp) {
        if (!timestamp) return '';
        return new Date(timestamp).toLocaleString(undefined, {
          month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit'
        });
      }

      function escapeHtml(str) {
        return (str || '')
          .replaceAll('&','&amp;')
          .replaceAll('<','&lt;')
          .replaceAll('>','&gt;')
          .replaceAll('"','&quot;')
          .replaceAll("'","&#039;");
      }

      async function copyPrompt() {
        if (!state.currentPromptText) return;
        const defaultLabel = 'Copy Prompt';

        try {
          await navigator.clipboard.writeText(state.currentPromptText);
          copyBtn.textContent = 'Copied!';
        } catch {
          const textarea = document.createElement('textarea');
          textarea.value = state.currentPromptText;
          textarea.setAttribute('readonly', '');
          textarea.style.position = 'absolute';
          textarea.style.left = '-9999px';
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
          copyBtn.textContent = 'Copied!';
        }

        setTimeout(() => {
          if (copyBtn) copyBtn.textContent = defaultLabel;
        }, 1200);
      }
    })();
  </script>
</body>
</html>
